/* Numbering test. Auto Generated using http://lesscss.org */

// For debugging, mark start and end brackets
@S: ""; //" ["; // "S"tart and "E"nd marking text for debugging
@E: " "; //"] ";

// Strings that are used (note some have spaces at the end)
@chapter: "Chapter";
@appendix: "Appendix";
@figure: "Figure ";
@table: "Table ";
@example: "Example ";
@exercise: "Exercise ";


/* --------------------------------------
 *  Define how counters are incremented
 * --------------------------------------
 */
body { counter-reset: chapter appendix; }
.chapter  { counter-increment: chapter;  .x-prefixed (@chapter, chapter); } //Also, generate all the rules at this point
.appendix { counter-increment: appendix; .x-prefixed (@appendix, appendix, upper-latin); }

/* Still count the element but don't show it */
.empty {
  visibility: hidden;
  max-height: 0em;
}

.x-debug () {
  color: red; background-color: white;
  font-weight: bold;
}


.x-prefixed (@part-label, @part, @style: decimal) {

  //This convoluted path is used to suck up (via the "content()") the title of the chapter into the header
  .titlepage h1.title .cnx-gentext-t {
    string-set: cnx-header @S @part-label " " counter(@part, @style) " | " content() @E;
  }
  
  counter-reset: section figure table equation example exercise toc-section;
  
  .cnx-eoc { counter-reset: exercise eoc-section; }
  /* .cnx-eoc + .cnx-eoc { counter-reset: none; } */ /* Don't reset for each eoc section */
  
  & > .section  { counter-increment: section; }   // Only increment top-level sections
  .figure       { counter-increment: figure; }
  .table        { counter-increment: table; }
  .example      { counter-increment: example; }
  .exercise     { counter-increment: exercise; }
  .equation     { counter-increment: equation; }
  /* Cases where sections are referenced */
  & > .toc dt   { counter-increment: toc-section; } // TODO: toc-section could just be looked up via CSS3 taarget-counter (but then epub would break)
  & > .cnx-eoc > .section  { counter-increment: eoc-section; }
  
  /* When in some elements don't increment (or display) */
  .glossary *,
  .example .exercise *,
  .cnx-eoc .solution .figure,
  .cnx-eoc .solution .table,
  .cnx-eoc .solution .exercise,
  .cnx-eoc .solution .example,
  .cnx-eoc .solution .equation {
    counter-increment: none !important;
    /* Don't display the labels in glossaries, solutions, etc */
    &:before { color: #cccccc !important; /* should be display:none */ }
  }
  
  
  /* --------------------------------------
   *  Define where counters are displayed
   * --------------------------------------
   */
  .x-test-text (@label, @counter-name, @suffix: "") {
    &:before {
      content: @S @label counter(@part, @style) "." counter(@counter-name) @suffix @E;
    }
  }

/* Ah, to be so clean .... 
  & > .section > .titlepage h2 { .x-test-text ("", section); }
  .figure > .title             { .x-test-text (@figure, figure); }
  .table > table > caption     { .x-test-text (@table, table); }
  .example > .title > span     { .x-test-text (@example, example); }
  .exercise > .title > span:first-child    { .x-test-text ("", exercise); content: @S @exercise counter(exercise) @E; }
  .equation > .label           { .x-test-text ("(", equation, ")"); }
  & > .toc > dl > dt > a       { .x-test-text ("", toc-section); }
  .cnx-eoc > .section > .title { .x-test-text ("", eoc-section); }
*/

  /** Each thing appears 3 times because 1 implements the new numbering and the next 2 lines hide the docbook-generated text **/
  & > .titlepage .cnx-gentext-t { &:before { content: @S counter(@part, @style) @E;} }
  & > .titlepage .cnx-gentext-autogenerated,
  & > .titlepage .cnx-gentext-n  { display: none; }

  & > .section > .titlepage h2 { .x-test-text ("", section); }
  & > .section > .titlepage h2 > .cnx-gentext-autogenerated,
  & > .section > .titlepage h2 > .cnx-gentext-n { display: none; }
  
  .figure > .title .cnx-gentext-t { .x-test-text (@figure, figure); }
  .figure > .title .cnx-gentext-autogenerated,
  .figure > .title .cnx-gentext-n  { display: none; }
  
  .table > table > caption     { .x-test-text (@table, table); }
  .table > table > caption > .cnx-gentext-t,
  .table > table > caption > .cnx-gentext-n { display: none; }
  
  .example > .title > span     { .x-test-text (@example, example, "."); }
  .example > .title > span > .cnx-gentext-autogenerated,
  .example > .title > span > .cnx-gentext-n { display: none; }
  
  .exercise > .title > span:first-child    { &:before { content: @S @exercise counter(exercise) "." @E; } }
  .exercise > .title > span:first-child .cnx-gentext-autogenerated,
  .exercise > .title > span:first-child .cnx-gentext-n { display: none; }

  .cnx-eoc .exercise .problem:before { content: @S counter(exercise) "." @E; font-weight: bold; }
  .cnx-eoc .exercise > .title { display: none; }
  
  .equation > .label           { .x-test-text ("(", equation, ")"); }
  .equation > .label           { content: ""; }
  
  & > .toc > dl > dt > a       { .x-test-text ("", toc-section); }
  & > .toc > dl > dt > a .cnx-gentext-autogenerated,
  & > .toc > dl > dt > a .cnx-gentext-n { display: none; }

  .cnx-eoc > .section > .title .cnx-gentext-t { .x-test-text ("", eoc-section); }
  .cnx-eoc > .section > .title .cnx-gentext-autogenerated,
  .cnx-eoc > .section > .title .cnx-gentext-n { display: none; }



  /* Number links to different elements */
  .x-link (@label, @counter-name) {
    &:not(.labeled) { content: @S @label target-counter(attr(href), @part, @style) "." target-counter(attr(href), @counter-name) @E; }
  }
  .target-figure   { .x-link(@figure, figure); }
  .target-table    { .x-link(@table, table); }
  .target-example  { .x-link(@example, example); }
  .target-exercise { .x-link(@exercise, exercise); }

}

.solution > a.number:before {
  /* look up the exercise number */
  content: @S target-counter(attr(href, url), exercise) @E;
}
.solution > a.number {
  content: "";
}

/******************************
 * Number the book-level TOC
 ******************************/

/* Chapters/Appendixes */
.book > .toc > dl > dt > a.target-chapter:before { content: @chapter ": "; content: @S target-counter(attr(href), chapter, decimal) @E " "; }
.book > .toc > dl > dt > a.target-appendix:before { content: @appendix ": "; content: @S target-counter(attr(href), appendix, upper-latin)@E " "; }
.book > .toc > dl > dt > a .cnx-gentext-autogenerated,
.book > .toc > dl > dt > a .cnx-gentext-n { display: none; }

/* Sections */
.book > .toc > dl > dd   a:before { content: @S target-counter(attr(href), chapter, decimal) "." target-counter(attr(href), section) @E " "; }
.book > .toc > dl > dd   a .cnx-gentext-autogenerated,
.book > .toc > dl > dd   a .cnx-gentext-n { display: none; }

